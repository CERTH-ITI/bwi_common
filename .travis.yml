sudo: required
dist: bionic
language: minimal
cache:
  directories:
    - $HOME/.ccache
compiler:
  - gcc
services:
  - docker
git:
  submodules: false
env:
  global:
    - ROS_DISTRO="melodic"
    - REPO_GIT_URL="https://github.com/utexas-bwi/bwi_common.git"
    - IMAGE="ros:melodic-perception"
before_install:
    # Install gitmodules
    - git submodule init && git submodule sync && git submodule update
    - mkdir -p ~/catkin_ws/src
    # Noisy process, ignore output
    - sudo docker pull $IMAGE
    - sudo docker run --name=travis -dit -v ~/catkin_ws:/root/catkin_ws -v ~/.ccache:/root/.ccache -v $TRAVIS_BUILD_DIR:/root/travis $IMAGE
    - shopt -s expand_aliases
    - alias RUN="sudo docker exec -it travis /bin/bash -c"
    - RUN "sudo apt update"
    - RUN "sudo apt-get install python-catkin-tools"
install:
    - git clone $REPO_GIT_URL ~/catkin_ws/src/bwi_common
    - RUN "cd ~/catkin_ws/src/bwi_common && git submodule update --init --recursive && cd ~"
    # Install any ROS dependencies
    - RUN "source /opt/ros/melodic/setup.bash && rosdep update"
    - RUN 'source /opt/ros/melodic/setup.bash  && rosdep install -q -r --from-paths ~/catkin_ws --ignore-packages-from-source -y --rosdistro $ROS_DISTRO'
    # Setup catkin workspace (without RIS)
    - RUN "source /opt/ros/melodic/setup.bash  && cd ~/catkin_ws && catkin init"
before_script:
    # Link RIS repo to the catkin workspace
    - RUN 'ln -s ~/travis ~/catkin_ws/src'
    - RUN 'source /opt/ros/melodic/setup.bash  && rosdep install -q -r --from-paths ~/catkin_ws --ignore-packages-from-source -y --rosdistro $ROS_DISTRO'
script:

    - export packages=$($TRAVIS_BUILD_DIR/.travis/get_ws_packages.sh $TRAVIS_BUILD_DIR $TRAVIS_BUILD_DIR/.travis/package_blacklist.txt)
    - echo ${packages}
    - RUN "source /opt/ros/melodic/setup.bash  && cd ~/catkin_ws && catkin build ${packages} --no-status --summarize"
before_cache:
    - sudo chown -R travis:travis $HOME/.ccache
